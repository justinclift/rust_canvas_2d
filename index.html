<html>
  <head>
    <meta content="text/html;charset=utf-8" http-equiv="Content-Type"/>
    <title>Rust WebAssembly 2D Canvas example</title>
    <style>
      body,pre { margin:0;padding:0; }
      #mycanvas {
        position:fixed;
        opacity:1.0;
        width: 100%;
        height:100%;
        top:0;right:0;bottom:0;left:0;
        border: 1px solid black;
      }
    </style>
  </head>
  <body>
    <!-- Include the JS generated by `wasm-pack build` -->
    <script src='pkg/canvas_2d_test1.js'></script>

    <!-- Note the usage of `type=module` here as this is an ES6 module -->
    <script type="module">
      // Like with the `--target web` output the exports are immediately
      // available but they won't work until we initialize the module. Unlike
      // `--target web`, however, the globals are all stored on a
      // `wasm_bindgen` global. The global itself is the initialization
      // function and then the properties of the global are all the exported
      // functions.
      //
      // Note that the name `wasm_bindgen` can be configured with the
      // `--no-modules-global` CLI flag
      const { wasm_main, apply_transformation, key_press_handler, move_handler } = wasm_bindgen;

      // Apply the matrix transformations
      function applyTransformation() {
        apply_transformation();
      }

      // Pass key presses through to the wasm handler
      function keyPressHandler(evt) {
        let key = 0;
        switch(evt.key) {
          // Move keys
          case "d":
          case "D":
            key = 1;
            break;
          case "a":
          case "A":
            key = 2;
            break;
          case "w":
          case "W":
            key = 3;
            break;
          case "s":
          case "S":
            key = 4;
            break;

          // Rotate keys
          case "ArrowLeft":
          case "4":
            key = 5;
            break;
          case "ArrowRight":
          case "6":
            key = 6;
            break;
          case "ArrowUp":
          case "8":
            key = 7;
            break;
          case "ArrowDown":
          case "2":
            key = 8;
            break;
          case "PageUp":
          case "9":
            key = 9;
            break;
          case "PageDown":
          case "3":
            key = 10;
            break;
          case "Home":
          case "7":
            key = 11;
            break;
          case "End":
          case "1":
            key = 12;
            break;

          // Change step size keys
          case "-":
            key = 13;
            break;
          case "+":
            key = 14;
            break;

          // Unknown key press, don't pass it through
          default:
            return;
        }

        // console.log("JS: Key pressed = " + key);
        key_press_handler(key);
      }

      // Pass mouse movement events through to the wasm handler
      function moveHandler(evt) {
        // console.log(evt);
        move_handler(evt.clientX, evt.clientY);
      }

      // Launch the wasm file
      async function run() {
        await wasm_bindgen('./pkg/canvas_2d_test1_bg.wasm');
        wasm_main();

        // Set up event handlers
        document.addEventListener("keydown", keyPressHandler);
        document.getElementById("mycanvas").addEventListener("mousemove", moveHandler);

        // Set up basic render loop
        setInterval(function() {
          applyTransformation();
        }, 25);
      }
      run();
    </script>
    <canvas id="mycanvas">Your browser doesn't appear to support the canvas tag.</canvas>
  </body>
</html>
